# Deploy -- Build, push, and deploy on merge to main.
# Handles Docker image build + push to Artifact Registry, Cloud Run deploy,
# and Supabase migrations.

name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false # Never cancel an in-progress deploy.

env:
  GCP_REGION: us-central1
  ENVIRONMENT: dev

jobs:
  # --------------------------------------------------------------------------
  # Detect which directories changed to skip unnecessary work.
  # --------------------------------------------------------------------------
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      control-plane: ${{ steps.filter.outputs.control-plane }}
      agent-runtime: ${{ steps.filter.outputs.agent-runtime }}
      protocols: ${{ steps.filter.outputs.protocols }}
      dashboard: ${{ steps.filter.outputs.dashboard }}
      supabase: ${{ steps.filter.outputs.supabase }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before }}
          filters: |
            infra:
              - 'infra/**'
            control-plane:
              - 'services/control-plane/**'
            agent-runtime:
              - 'services/agent-runtime/**'
            protocols:
              - 'services/protocols/**'
            dashboard:
              - 'dashboard/**'
            supabase:
              - 'supabase/**'

  # --------------------------------------------------------------------------
  # Build & push Docker images for all changed services.
  # --------------------------------------------------------------------------
  build-push-control-plane:
    name: "Build & push control-plane"
    needs: changes
    if: needs.changes.outputs.control-plane == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Generate image metadata
        id: meta
        run: |
          REPO="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/agents-${{ env.ENVIRONMENT }}/control-plane"
          SHA_TAG="${REPO}:${{ github.sha }}"
          LATEST_TAG="${REPO}:latest"
          echo "image=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          echo "repo=${REPO}" >> "$GITHUB_OUTPUT"

      - uses: docker/build-push-action@v6
        with:
          context: services/control-plane
          push: true
          tags: |
            ${{ steps.meta.outputs.sha_tag }}
            ${{ steps.meta.outputs.latest_tag }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.repo }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.repo }}:buildcache,mode=max

  build-push-agent-runtime:
    name: "Build & push agent-runtime"
    needs: changes
    if: needs.changes.outputs.agent-runtime == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Generate image metadata
        id: meta
        run: |
          REPO="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/agents-${{ env.ENVIRONMENT }}/agent-runtime"
          SHA_TAG="${REPO}:${{ github.sha }}"
          LATEST_TAG="${REPO}:latest"
          echo "image=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          echo "repo=${REPO}" >> "$GITHUB_OUTPUT"

      - uses: docker/build-push-action@v6
        with:
          context: services/agent-runtime
          push: true
          tags: |
            ${{ steps.meta.outputs.sha_tag }}
            ${{ steps.meta.outputs.latest_tag }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.repo }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.repo }}:buildcache,mode=max

  build-push-protocols:
    name: "Build & push protocols"
    needs: changes
    if: needs.changes.outputs.protocols == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Generate image metadata
        id: meta
        run: |
          REPO="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/agents-${{ env.ENVIRONMENT }}/protocols"
          SHA_TAG="${REPO}:${{ github.sha }}"
          LATEST_TAG="${REPO}:latest"
          echo "image=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          echo "repo=${REPO}" >> "$GITHUB_OUTPUT"

      - uses: docker/build-push-action@v6
        with:
          context: services/protocols
          push: true
          tags: |
            ${{ steps.meta.outputs.sha_tag }}
            ${{ steps.meta.outputs.latest_tag }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.repo }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.repo }}:buildcache,mode=max

  # --------------------------------------------------------------------------
  # Deploy control-plane to Cloud Run.
  # --------------------------------------------------------------------------
  deploy-control-plane:
    name: "Deploy control-plane to Cloud Run"
    needs: build-push-control-plane
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Resolve runtime URLs
        id: urls
        run: |
          RT_URL=$(gcloud run services describe agent-runtime-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)' 2>/dev/null || echo "")
          echo "runtime_url=${RT_URL}" >> "$GITHUB_OUTPUT"

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: control-plane-api
          region: ${{ env.GCP_REGION }}
          image: ${{ needs.build-push-control-plane.outputs.image }}
          env_vars: |
            NODE_ENV=production
            ENVIRONMENT=${{ env.ENVIRONMENT }}
            GCP_PROJECT=${{ secrets.GCP_PROJECT_ID }}
            GCP_REGION=${{ env.GCP_REGION }}
            AGENT_RUNTIME_URL=${{ steps.urls.outputs.runtime_url }}
          secrets: |
            SUPABASE_URL=agents-supabase-url-${{ env.ENVIRONMENT }}:latest
            SUPABASE_SERVICE_ROLE_KEY=agents-supabase-key-${{ env.ENVIRONMENT }}:latest
          flags: |
            --vpc-connector=projects/${{ secrets.GCP_PROJECT_ID }}/locations/${{ env.GCP_REGION }}/connectors/agents-vpc

      - name: Verify deployment
        run: |
          URL=$(gcloud run services describe control-plane-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "Service URL: ${URL}"
          for i in $(seq 1 10); do
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' "${URL}/health" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed."
              exit 0
            fi
            echo "Attempt ${i}/10: got HTTP ${STATUS}, retrying in 10s..."
            sleep 10
          done
          echo "WARNING: Health check did not return 200 after 10 attempts."
          exit 1

  # --------------------------------------------------------------------------
  # Deploy agent-runtime to Cloud Run.
  # --------------------------------------------------------------------------
  deploy-agent-runtime:
    name: "Deploy agent-runtime to Cloud Run"
    needs: build-push-agent-runtime
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: agent-runtime-api
          region: ${{ env.GCP_REGION }}
          image: ${{ needs.build-push-agent-runtime.outputs.image }}
          env_vars: |
            NODE_ENV=production
            ENVIRONMENT=${{ env.ENVIRONMENT }}
            PORT=8081
            GCP_PROJECT=${{ secrets.GCP_PROJECT_ID }}
            GCP_REGION=${{ env.GCP_REGION }}
          secrets: |
            SUPABASE_URL=agents-supabase-url-${{ env.ENVIRONMENT }}:latest
            SUPABASE_SERVICE_ROLE_KEY=agents-supabase-key-${{ env.ENVIRONMENT }}:latest
          flags: |
            --vpc-connector=projects/${{ secrets.GCP_PROJECT_ID }}/locations/${{ env.GCP_REGION }}/connectors/agents-vpc

      - name: Verify deployment
        run: |
          URL=$(gcloud run services describe agent-runtime-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "Service URL: ${URL}"
          for i in $(seq 1 10); do
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' "${URL}/health" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed."
              exit 0
            fi
            echo "Attempt ${i}/10: got HTTP ${STATUS}, retrying in 10s..."
            sleep 10
          done
          echo "WARNING: Health check did not return 200 after 10 attempts."
          exit 1

  # --------------------------------------------------------------------------
  # Deploy protocols service to Cloud Run.
  # --------------------------------------------------------------------------
  deploy-protocols:
    name: "Deploy protocols to Cloud Run"
    needs: build-push-protocols
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Resolve service URLs
        id: urls
        run: |
          CP_URL=$(gcloud run services describe control-plane-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)' 2>/dev/null || echo "")
          RT_URL=$(gcloud run services describe agent-runtime-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)' 2>/dev/null || echo "")
          echo "cp_url=${CP_URL}" >> "$GITHUB_OUTPUT"
          echo "rt_url=${RT_URL}" >> "$GITHUB_OUTPUT"

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: protocols-api
          region: ${{ env.GCP_REGION }}
          image: ${{ needs.build-push-protocols.outputs.image }}
          env_vars: |
            NODE_ENV=production
            ENVIRONMENT=${{ env.ENVIRONMENT }}
            PORT=8082
            CONTROL_PLANE_URL=${{ steps.urls.outputs.cp_url }}
            AGENT_RUNTIME_URL=${{ steps.urls.outputs.rt_url }}
          secrets: |
            INTERNAL_API_KEY=agents-internal-api-key-${{ env.ENVIRONMENT }}:latest
          flags: |
            --vpc-connector=projects/${{ secrets.GCP_PROJECT_ID }}/locations/${{ env.GCP_REGION }}/connectors/agents-vpc

      - name: Verify deployment
        run: |
          URL=$(gcloud run services describe protocols-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "Service URL: ${URL}"
          for i in $(seq 1 5); do
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' "${URL}/health" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed."
              exit 0
            fi
            echo "Attempt ${i}/5: got HTTP ${STATUS}, retrying in 10s..."
            sleep 10
          done
          echo "WARNING: Health check did not return 200 after 5 attempts."
          exit 1

  # --------------------------------------------------------------------------
  # Build & push dashboard Docker image.
  # --------------------------------------------------------------------------
  build-push-dashboard:
    name: "Build & push dashboard"
    needs: changes
    if: needs.changes.outputs.dashboard == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Generate image metadata
        id: meta
        run: |
          REPO="${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/agents-${{ env.ENVIRONMENT }}/dashboard"
          SHA_TAG="${REPO}:${{ github.sha }}"
          LATEST_TAG="${REPO}:latest"
          echo "image=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${SHA_TAG}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          echo "repo=${REPO}" >> "$GITHUB_OUTPUT"

      - name: Resolve control plane URL
        id: urls
        run: |
          CP_URL=$(gcloud run services describe control-plane-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)' 2>/dev/null || echo "")
          echo "cp_url=${CP_URL}" >> "$GITHUB_OUTPUT"

      - uses: docker/build-push-action@v6
        with:
          context: dashboard
          push: true
          tags: |
            ${{ steps.meta.outputs.sha_tag }}
            ${{ steps.meta.outputs.latest_tag }}
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_API_URL=${{ steps.urls.outputs.cp_url }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.repo }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.repo }}:buildcache,mode=max

  # --------------------------------------------------------------------------
  # Deploy dashboard to Cloud Run.
  # --------------------------------------------------------------------------
  deploy-dashboard:
    name: "Deploy dashboard to Cloud Run"
    needs: build-push-dashboard
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: dashboard
          region: ${{ env.GCP_REGION }}
          image: ${{ needs.build-push-dashboard.outputs.image }}
          env_vars: |
            NODE_ENV=production
            HOSTNAME=0.0.0.0
            PORT=3000

      - name: Verify deployment
        run: |
          URL=$(gcloud run services describe dashboard \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "Dashboard URL: ${URL}"
          for i in $(seq 1 10); do
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' "${URL}" || true)
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "307" ]; then
              echo "Dashboard is responding."
              exit 0
            fi
            echo "Attempt ${i}/10: got HTTP ${STATUS}, retrying in 10s..."
            sleep 10
          done
          echo "WARNING: Dashboard did not respond after 10 attempts."
          exit 1

  # --------------------------------------------------------------------------
  # Run Supabase migrations.
  # --------------------------------------------------------------------------
  migrate-supabase:
    name: "Run Supabase migrations"
    needs: changes
    if: needs.changes.outputs.supabase == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run migrations
        run: |
          supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_REF }}"
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # --------------------------------------------------------------------------
  # Pulumi deploy (dev stack) when infra/ changes.
  # --------------------------------------------------------------------------
  pulumi-deploy:
    name: "Pulumi up (dev)"
    needs: changes
    if: needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: infra/package-lock.json

      - run: npm ci

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: pulumi/actions@v6
        with:
          command: up
          stack-name: dev
          work-dir: infra
          cloud-url: https://api.pulumi.com
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
